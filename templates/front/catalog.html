{% extends "front/index.html" %}
{% block title %}Catalog{% endblock %}
{% block content %}
    <h1>Product Catalog</h1>

{% if query or min_price or max_price %}
  <p>
    Showing {{ result_count }} result{{ '' if result_count==1 else 's' }}
    {% if query %} for “{{ query }}”{% endif %}
    {% if min_price or max_price %}
      {% if min_price %} min ${{ min_price }}{% endif %}
      {% if max_price %} max ${{ max_price }}{% endif %}
    {% endif %}
    — <a href="{{ url_for('catalog') }}">clear</a>
  </p>
{% endif %}
    <div class="catalog-grid">
      {% for product in products %}
        <div class="catalog-card">
          <!-- Handles both external and local images -->
          <img
            src="{% if product.image.startswith('http') %}{{ product.image }}{% else %}{{ url_for('static', filename='images/' + product.image) }}{% endif %}"
            alt="{{ product.title }}">
          <div class="catalog-info">
            <div class="catalog-name">{{ product.title }}</div>
            <div class="catalog-price">${{ product.price }}</div>
            <a class="catalog-details-link" href="{{ url_for('product_detail', pid=product.id) }}">View Details</a>
          </div>
{#          <a class="catalog-add-btn" href="{{ url_for('add_to_cart', pid=product.id) }}" role="action">Add to Cart</a>#}
            <button class="catalog-add-btn add-to-cart" type="button" data-id="{{ product.id }}">
              Add to Cart
            </button>
            <noscript>
              <a class="catalog-add-btn" href="{{ url_for('add_to_cart', pid=product.id) }}">Add to Cart</a>
            </noscript>
        </div>
      {% endfor %}
    </div>
{% endblock %}

{% block extra_scripts %}
<script>
  document.querySelectorAll('.add-to-cart').forEach(btn => {
    btn.addEventListener('click', async () => {
      const pid = btn.dataset.id;
      try {
        const res = await fetch(`{{ url_for('add_to_cart', pid=0) }}`.replace('0', pid), {
          method: 'POST',
          headers: { 'X-Requested-With': 'fetch' }
        });
        const data = await res.json();
        if (data.success) {
          // update the cart badge
          const badge = document.getElementById('cart-count');
          if (badge) badge.textContent = data.cart_count;

          // Pretty popup (like your image)
          Swal.fire({
            icon: 'success',
            title: 'Add To Cart',
            text: 'Successfully!',
            confirmButtonText: 'OK'
          });
        } else {
          Swal.fire({ icon: 'error', title: 'Oops', text: data.error || 'Failed to add item.' });
        }
      } catch (e) {
        Swal.fire({ icon: 'error', title: 'Network error', text: 'Please try again.' });
      }
    });
  });
</script>
{% endblock %}


